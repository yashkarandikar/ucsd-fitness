% THIS IS SIGPROC-SP.TEX - VERSION 3.1
% WORKS WITH V3.2SP OF ACM_PROC_ARTICLE-SP.CLS
% APRIL 2009
%
% It is an example file showing how to use the 'acm_proc_article-sp.cls' V3.2SP
% LaTeX2e document class file for Conference Proceedings submissions.
% ----------------------------------------------------------------------------------------------------------------
% This .tex file (and associated .cls V3.2SP) *DOES NOT* produce:
%       1) The Permission Statement
%       2) The Conference (location) Info information
%       3) The Copyright Line with ACM data
%       4) Page numbering
% 
\documentclass{acm_proc_article-sp}
\usepackage{comment}
\usepackage{url}
\usepackage{float}
\usepackage{needspace}

\begin{document}

\title{Modeling Temporal Evolution in the Endomondo Fitness Data Set}
%
\numberofauthors{2} % section.
%
\author{
\alignauthor
Yashodhan Hemant Karandikar\\
%       \email{ykarandi@ucsd.edu} \\
\bigskip
       {Advisor : Prof. Julian McAuley}
}


\maketitle
\begin{abstract}
The goal of this project is to model temporal evolution of runners' capacity across workouts as well as within each workout. We study this temporal evolution over 2 predictive tasks - prediction of duration of the next workout given previous workouts and prediction of average and instantaneous heart-rates. We show that accounting for temporal evolution improves results on these predictive tasks on the Endomondo fitness data set \cite{endomondo}.
\end{abstract}

\section{Introduction}
People work out with the goal of becoming fitter. Regularly working out enables a person to take on more challenging work outs. For example, a runner training for long distance running can gradually attempt runs of longer durations. Thus, the running capacity or the fitness level of the person increases gradually with practice. Modeling this fitness level can be useful in order to be able to predict the duration of the next workout that the runner attempts. Such a prediction can be useful both as a goal and as a guide to the runner while planning the run.

Alternatively, runners often monitor their heart-rate while running and set goals of keeping the heart-rate below or above a certain value, either for improving their fitness level or for their own safety. The heart-rate at future instants in the run depends on how tired the runner is currently, among other factors. Further, this relationship between the heart-rate and how tired the runner is, varies from one runner to another. For example, an experienced runner might experience only a slight increase in heart-rate as he or she is more tired, while the heart-rate of an amateur runner might shoot up soon after the run starts.

The examples above highlight the temporal evolution of a runner's capacity, both across workouts and within each workout. We attempt to model both these forms of temporal evolution in this work.

\section{Predictive Tasks}
In order to study temporal evolution of a runner \emph{across} several workouts, we choose the following 2 predictive tasks as follows:
\begin{enumerate}
\item Given the distance $d_i$ and duration $T_i$ for each workout $i$ among first $n$ workouts of a user $u$ and given the distance $d_{n+1}$ for the $(n+1)$'th workout, predict the duration $T_{n+1}$ of the $(n+1)$'th workout.
\item Given the distance $d_i$ and average heart-rate $H_i$ for each workout $i$ among first $n$ workouts of a user $u$ and given the distance $d_{n+1}$ for the $(n+1)$'th workout, predict the average heart-rate $H_{n+1}$ of the $(n+1)$'th workout.
\end{enumerate}

In order to study temporal evolution of a runner \emph{within} \emph{each} workout, we choose the following 2 predictive tasks as follows:

\begin{enumerate}
\item Given the first $n$ instantaneous heart-rates of a workout, predict the $(n+1)$'th instantaneous heart-rate.
\item Given the instantaneous heart-rates of the first $f$ fraction of a workout, predict the heart-rates of the remaining $1-f$ fraction of the workout. This task is a generalization of the first.
\end{enumerate}

\section{Related Work}
\cite{www13} describes various models which account for temporal evolution of user expertise through online reviews on websites such as Amazon, BeerAdvocate, RateBeer, CellarTracker. 

\section{Endomondo Fitness data set}
\label{expAnalysis}
In this section, we introduce the Endomondo fitness data set. \cite{mldataset}. 

\subsection{Extracting relevant data}
\subsection{Exploratory Analysis}

\begin{comment}
\begin{figure}[h]
\centering
\includegraphics[scale=0.4]{plots/rating_vs_age}
\caption{\label{plotRatingVsAge}Average rating for different age groups}
\end{figure}

\begin{figure*}
\centering
\includegraphics[scale=0.4]{plots/rating_vs_occupation}
\caption{\label{plotRatingVsOcc} Average rating for various occupations}
\end{figure*}
\end{comment}

\begin{comment}
\begin{figure*}
\centering
\includegraphics[scale=0.4]{plots/rating_vs_genre}
\caption{\label{plotRatingVsGenre} Average rating for various movie genres}
\end{figure*}
\end{comment}

\section{Baseline Model}
\label{secBaselineModel}
This section describes a baseline model to predict the duration of a workout given the distance.

\section{Temporal Evolution of Users}
\label{secTemporalModelUsers}
This section describes a model that attempts to account for temporal evolution of users across workouts. First, we describe the model and then describe the training algorithm.

\subsection{Model Specification}
In order to account for evolution in the fitness level or capability of a user over time,  we associate a \emph{experience level} or \emph{fitness level} $e_{uw}$ with each workout $w$ of user $u$. This can be seen as a way of encoding how fit the user is at the time of the workout $w$. The value $e_{uw}$ is an integer in the interval $[0, E)$ where $E$ is the number of experience levels. 

Intuitively, we expect the experience level of a user to either stay the same or increase with each workout. We encode this intuition in the form of a monotonicity constraint on the experience levels of workouts for each user, as given below \cite{www13}:

$$\forall u,i,j \;\;\;\;\; t_{ui} \geq t_{uj} \implies e_{ui} \geq e_{uj}$$

where $t_{ui}$ is the time at which workout $i$ of user $u$ occurs.

Then, given the total distance $d_{ui}$ for the $i$'th workout of user $u$, the predicted duration $T_{ui}'$ of the workout is given by:

\begin{equation}
\label{eqnModelDuration}
T_{ui}' = (\alpha_{e_{ui}} + \alpha_{ue_{ui}})(\theta_0 + \theta_1 d_{ui})
\end{equation}


where $e_{ui}$ is the experience level of the user $u$ at the $i$'th workout. Thus, we have one parameter $\alpha_{ue}$ per user $u$ per experience level $e$. Further, we have an intercept term $\alpha_e$ for every experience level $e$, common to all users. The terms $\theta_0$ and $\theta_1$ are global to all users and experience levels. Thus, given $U$ users and $E$ experience levels, we have a total of $UE + E + 2$ parameters.

Note that setting $E = 1$ reduces the model to the baseline model described in section \ref{secBaselineModel}.

We can specify a similar model for the predicted average heart rate $H_{ui}'$ of the user $u$ during the workout $i$:

\begin{equation}
\label{eqnModelAvgHr}
H_{ui}' = (\alpha_{e_{ui}} + \alpha_{ue_{ui}})(\theta_0 + \theta_1 d_{ui})
\end{equation}

\subsection{Objective Function}
As explained above, we have a different model for each of the $E$ experience levels. Each of the $E$ models has the following parameters:

$$\Theta_e = (\alpha_e; \alpha_{1e}...\alpha_{Ue})$$

where $1 \leq e \leq E$ is the experience level and $U$ is the number of distinct users.

Thus, all the parameters in all of the $E$ models together can be written as:

$$\Theta = (\Theta_1, \Theta_2,..., \Theta_E)$$

Let $\beta$ denote the set of all experience parameters $e_{ui}$. Then, we need to choose the optimal parameters $(\hat{\Theta}, \hat{\beta})$ according to the objective

%$$(\hat{\Theta}, \hat{\beta})  =  \arg\min_{\Theta,\beta}\frac{1}{|D|} \sum_{T_{ui} \in D}(T_{ui}' - T_{ui})^2 + \lambda_1\Omega_1(\Theta) + \lambda_2\Omega_2(\Theta, \theta_1) $$

\begin{align}
\label{eqnObjective}
(\hat{\Theta}, \hat{\beta})  &= \arg\min_{\Theta,\beta}\frac{1}{|D|} \sum_{T_{ui} \in D}(T_{ui}' - T_{ui})^2 \nonumber \\
 & + \lambda_1\Omega_1(\Theta) + \lambda_2\Omega_2(\Theta, \theta_1)
\end{align}

$$s.t. \; \; \; t_{ui} \geq t_{uj} \implies e_{ui} \geq e_{uj} $$

where $D$ is the data set of all workouts for all users. This objective is similar to the one described in \cite{www13}. $\Omega_1$ and $\Omega_2$ are regularizers defined as follows:

$$\Omega_1(\Theta) = \sum_{e=1}^{E-1}{\|\Theta_e - \Theta_{e+1}\|_2^2}$$

and

$$\Omega_2(\Theta, \theta_1) = \theta_1^2 + \sum_{e=1}^{E}{\|\Theta_e \|_2^2}$$

$\Omega_1$ is a smoothness function which penalizes abrupt changes between successive experience levels \cite{www13}, since in practice similar experience levels should have similar parameters \cite{www13}. $\Omega_2$ is another regularizer which penalizes complex models i.e. it penalizes models which have higher magnitudes of parameters. These regularizers are necessary to avoid overfitting, since we have a large number $(UE + E + 2)$ of parameters. $\lambda_1$ and $\lambda_2$ are regularization hyperparameters, which trade-off the importance of regularization versus prediction accuracy at training time \cite{www13}. We select $\lambda_1$ and $\lambda_2$ through a grid-search over values in the set $\{0.0, 10^{-3}, 10^{-2}, 10^{-1}, 10^0, 10^1\}$ and select the values which yield the highest prediction accuracy on a validation set.

For the task of predicting the average heart rate instead of the duration of the workout, the objective function remains the same as in equation \ref{eqnObjective}, except that the term $T_{ui}' - T_{ui}$ is replaced by $H_{ui}' - H_{ui}$.

\subsection{Training the model}
We optimize the parameters $\Theta$ and $\beta$ using a co-ordinate descent \cite{coordinateDescentWiki} i.e. we alternately optimize equation \ref{eqnObjective} for $\Theta$ given $\beta$ and $\beta$ given $\Theta$. We optimize the model parameters $\Theta$ given $\beta$ using L-BFGS \cite{lbfgs} available in the SciPy library \cite{scipy}. Optimizing $\beta$ given $\Theta$ means assigning a experience level to each workout so that the mean-squared-error is minimized, subject to the monotonicity constraint \cite{www13}. Since the experience levels are discrete, this problem can be solved efficiently using dynamic programming, as is done in \cite{www13}.

We alternately optimize $\Theta$ given $\beta$ and $\beta$ given $\Theta$ until $\beta$ does not change.

\subsection{Inference}
Once the model parameters and experience levels have been learned, we infer i.e. predict the duration or average heart rate for the next workout $w$ using equation \ref{eqnModelDuration} or \ref{eqnModelAvgHr}. Note that we need to estimate the experience level for workout $w$ in order to be able to use equation \ref{eqnModelDuration} or \ref{eqnModelAvgHr} to predict the duration or average heart-rate. We estimate this experience level in 2 different modes of inference, namely \emph{final} and \emph{random}. 

In the \emph{final} mode of inference, we use the first $N-2$ workouts as the training set, the $N-1$'th workout as the validation set and the $N$'th workout as the test set, where $N$ is the total number of workouts for a user $u$ in the data set. We assume $e_{u(N)} = e_{u(N-1)} = e_{u(N-2)}$ and use these experience levels to predict the duration (using equation \ref{eqnModelDuration}) or average heart rate (using equation \ref{eqnModelAvgHr}).

In the \emph{random} mode of inference, we randomly select 1 workout as the validation set and 1 workout as the test set. The experience levels for these workouts is assumed to be equal to those of the workouts closest in time in the training set. 

We present results for both modes of inference in section \ref{secEvaluation}.

\section{Temporal Evolution of Workouts}
\label{secTemporalModelWorkouts}
We now consider temporal evolution of a runner's capacity \emph{during} a workout and use it to predict the runner's instantaneous heart rate in the future. 

\subsection{Model Specification}

Given the heart-rate at various instants in a workout, we associate a \emph{tiredness level} $e_{wi}$ with heart-rate sample $i$ in the workout $w$. As before, the value $e_{wt}$ is an integer in the interval $[0, E)$, where $E$ is the number of tiredness levels. We expect the tiredness level of the user to either stay the same or increase with each sample in the workout. We encode this in the form of a monotonicity constraint as before:

$$\forall w,i,j \;\;\;\;\; t_{wi} \geq t_{wj} \implies e_{wi} \geq e_{wj}$$

where $t_{wi}$ is the time at which sample $i$ in workout $w$ was sampled.

Then, given the distance covered $d_{wt}$ at sample $t$ for the $w$'th workout, the predicted instantaneous heart-rate $h_{wt}'$ of the user is given by:

\begin{equation}
\label{eqnModelInstHr}
h_{wt}' = (\alpha_{e_{wt}} + \alpha_{ue_{wt}})(\theta_0 + \theta_1 d_{wt})
\end{equation}

where $e_{wt}$ is the tiredness level of the user at the $t$'th sample in workout $w$. Thus, as before, we have one parameter $\alpha_{we}$ per workout $w$ per tiredness level $e$ and an intercept term $\alpha_e$ for every tiredness level $e$, common to all workouts. The terms $\theta_0$ and $\theta_1$ are global to all workouts and tiredness levels. Thus, given $W$ workouts and $E$ tiredness levels, we have a total of $WE + E + 2$ parameters.

\subsection{Objective Function}
As before, we have a different model for each of the $W$ tiredness levels. Each of the $E$ models has the following parameters:

$$\Theta_e = (\alpha_e; \alpha_{1e}...\alpha_{We})$$

where $1 \leq e \leq E$ is the experience level and $W$ is the number of workouts in the data set.

Thus, all the parameters in all of the $E$ models together can be written as:

$$\Theta = (\Theta_1, \Theta_2,..., \Theta_E)$$

Let $\beta$ denote the set of all experience parameters $e_{wt}$. Then, we need to choose the optimal parameters $(\hat{\Theta}, \hat{\beta})$ according to the objective

\begin{align}
\label{eqnObjective2}
(\hat{\Theta}, \hat{\beta})  &= \arg\min_{\Theta,\beta}\frac{1}{|D|} \sum_{h_{wt} \in D}(h_{wt}' - h_{wt})^2 \nonumber \\
 & + \lambda_1\Omega_1(\Theta) + \lambda_2\Omega_2(\Theta, \theta_1)
\end{align}

$$s.t. \; \; \; t_{wi} \geq t_{wj} \implies e_{wi} \geq e_{wj} $$

where $D$ is the data set of all workouts for all users. This objective is similar to the one described in \cite{www13}.

As before, $\Omega_1$ and $\Omega_2$ are regularizers defined as follows:

$$\Omega_1(\Theta) = \sum_{e=1}^{E-1}{\|\Theta_e - \Theta_{e+1}\|_2^2}$$

$$\Omega_2(\Theta, \theta_1) = \theta_1^2 + \sum_{e=1}^{E}{\|\Theta_e \|_2^2}$$

$\Omega_1$ is a smoothness function which penalizes abrupt changes between successive tiredness levels \cite{www13}, since in practice similar tiredness levels should have similar parameters \cite{www13}. $\Omega_2$ is another regularizer which penalizes complex models i.e. it penalizes models which have higher magnitudes of parameters. These regularizers are necessary to avoid overfitting, since we have a large number $(WE + E + 2)$ of parameters. $\lambda_1$ and $\lambda_2$ are regularization hyperparameters, which trade-off the importance of regularization versus prediction accuracy at training time \cite{www13}. We select $\lambda_1$ and $\lambda_2$ through a grid-search over values in the set $\{0.0, 10^{-3}, 10^{-2}, 10^{-1}, 10^0, 10^1\}$ and select the values which yield the highest prediction accuracy on a validation set.

\subsection{Training the model}
The training algorithm is identical to the training algorithm described in section \ref{secTemporalModelUsers}.

\subsection{Inference}
Once the model parameters and tiredness levels have been learned, we infer i.e. predict the instantaneous heart rate at 1 instant in each workout $w$ using equation \ref{eqnModelInstHr}. As before, we need to estimate the tiredness level at that instant in order to be able to use equation \ref{eqnModelInstHr} to predict the instantaneous heart-rate. We estimate this tiredness levels in 2 different modes of inference, namely \emph{final} and \emph{random}. 

In the \emph{final} mode of inference, we use the first $N-2$ samples in each workout as the training set, the $N-1$'th sample from each workout as the validation set and the $N$'th sample as the test set, where $N$ is the total number of samples in a workout. We assume $e_{wN} = e_{w(N-1)} = e_{w(N-2)}$ and use these tiredness levels to predict the instantaneous heart-rate using equation \ref{eqnModelInstHr}.

In the \emph{random} mode of inference, we randomly select 1 sample from each workout as the validation set and 1 sample from each workout as the test set. The tiredness level for these samples is assumed to be equal to those of the samples closest in time in the training set. 

We present results for both modes of inference in section \ref{secEvaluation}.

\subsection{Prediction of several instantaneous heart rate values}
We now generalize the problem of predicting 1 instantaneous heart-rate value to predicting the heart-rate values for the last $f$ fraction of the workout. We use the same model as in section \ref{secTemporalModelWorkouts}. Let $e_{wn}$ be the tiredness level of the last sample in the training set. In order to predict the instantaneous heart-rate values in the remaining part of the workout, we assume $e_{w(n+1)} = e_{w(n+2)} = ... = e_{w(N)}$ where $N$ is the total number of samples in workout $w$. In other words, we assume that the last tiredness level of the workout fitted during training stays the same for the remaining part of the workout. In practice, this is not a valid assumption, but this provides us with a conservative estimate of how well the model performs on the remaining part of the workout i.e. on the validation and test sets.

Also note that the difficulty is not only that of estimating the tiredness levels accurately, but also not having learned model parameters for tiredness levels beyond the last tiredness level fitted during training. Thus, even if the true tiredness levels for the remaining part of the workout are known, these cannot be used for prediction of heart-rate values.

\section{Implementation Details}
\subsection{Verifying correctness}
\subsection{Performance}

%\needspace{2\baselineskip}
\section{Evaluation}
\label{secEvaluation}

\subsection{Temporal evolution in users}
\subsubsection{Prediction of duration}
We now present result for prediction of duration (final mode of evaluation).
\begin{table}[h]
\centering
\begin{tabular}{|c|c|c|c|} \hline
& Training $R^2$ & Validation $R^2$ & Test $R^2$ \\ \hline
\# Examples &  &  &  \\ \hline
Baseline ($E = 1$) & & & \\ \hline
$E = 2$ & & & \\ \hline
$E = 3$ & & & \\ \hline
\end{tabular}
\caption{Prediction of duration - \emph{Final} mode of evaluation }
\label{tableDurationFinal}
\end{table}

We now present result for prediction of duration (random mode of evaluation).
\begin{table}[h]
\centering
\begin{tabular}{|c|c|c|c|} \hline
& Training $R^2$ & Validation $R^2$ & Test $R^2$ \\ \hline
\# Examples &  &  &  \\ \hline
Baseline ($E = 1$) & & & \\ \hline
$E = 2$ & & & \\ \hline
$E = 3$ & & & \\ \hline
\end{tabular}
\caption{Prediction of duration - \emph{Random} mode of evaluation }
\label{tableDurationRandom}
\end{table}

\subsubsection{Prediction of average heart-rate}

We now present result for prediction of average heart-rate (final mode of evaluation).
\begin{table}[h]
\centering
\begin{tabular}{|c|c|c|c|} \hline
& Training $R^2$ & Validation $R^2$ & Test $R^2$ \\ \hline
\# Examples &  &  &  \\ \hline
Baseline ($E = 1$) & & & \\ \hline
$E = 2$ & & & \\ \hline
$E = 3$ & & & \\ \hline
\end{tabular}
\caption{Prediction of avg. heart-rate - \emph{Final} mode of evaluation }
\label{tableAvgHrFinal}
\end{table}

We now present result for prediction of average heart-rate (random mode of evaluation).
\begin{table}[h]
\centering
\begin{tabular}{|c|c|c|c|} \hline
& Training $R^2$ & Validation $R^2$ & Test $R^2$ \\ \hline
\# Examples &  &  &  \\ \hline
Baseline ($E = 1$) & & & \\ \hline
$E = 2$ & & & \\ \hline
$E = 3$ & & & \\ \hline
\end{tabular}
\caption{Prediction of avg. heart-rate - \emph{Random} mode of evaluation }
\label{tableAvgHrRandom}
\end{table}

\subsection{Temporal evolution in workouts}
\subsubsection{Prediction of 1 heart-rate value}
We now present result for prediction of the last instantaneous heart-rate value (final mode of evaluation)
\begin{table}[h]
\centering
\begin{tabular}{|c|c|c|c|} \hline
& Training $R^2$ & Validation $R^2$ & Test $R^2$ \\ \hline
\# Examples &  &  &  \\ \hline
Baseline ($E = 1$) & & & \\ \hline
$E = 10$ & & & \\ \hline
\end{tabular}
\caption{Prediction of instantaneous heart-rate - \emph{Final} mode of evaluation }
\label{tableInstHrFinal}
\end{table}

We now present result for prediction of the last instantaneous heart-rate value (final mode of evaluation)
\begin{table}[h]
\centering
\begin{tabular}{|c|c|c|c|} \hline
& Training $R^2$ & Validation $R^2$ & Test $R^2$ \\ \hline
\# Examples &  &  &  \\ \hline
Baseline ($E = 1$) & & & \\ \hline
$E = 10$ & & & \\ \hline
\end{tabular}
\caption{Prediction of instantaneous heart-rate - \emph{Random} mode of evaluation }
\label{tableInstHrRandom}
\end{table}

\subsubsection{Prediction of last several heart-rate values}

We now present result for prediction of the last several instantaneous heart-rate value (final mode of evaluation)

\begin{table}[h]
\centering
\begin{tabular}{|c|c|c|c|} \hline
& Training $R^2$ & Validation $R^2$ & Test $R^2$ \\ \hline
\# Examples &  &  &  \\ \hline
Baseline ($E = 1$) & & & \\ \hline
$E = 10$ & & & \\ \hline
\end{tabular}
\caption{Prediction of several instantaneous heart-rates}
\label{tableInstManyHr}
\end{table}


\section{Conclusion and Future Work}

\bibliographystyle{abbrv}
\bibliography{references.bib}

\end{document}
